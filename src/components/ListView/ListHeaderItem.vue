<template>
  <div
    ref="columnRef"
    class="group relative flex items-center"
    :class="item.align ? alignmentMap[item.align] : 'justify-between'"
  >
    <div
      class="flex items-center space-x-2 truncate text-sm text-ink-gray-5"
      :class="$attrs.class"
    >
      <slot name="prefix" v-bind="{ item }" />
      <slot>
        <div class="truncate">
          {{ item.label }}
        </div>
      </slot>
      <slot name="suffix" v-bind="{ item }" />
    </div>
    <slot v-if="list?.options.resizeColumn" name="resizer" v-bind="{ item }">
      <div
        class="flex h-4 absolute -right-2 w-2 cursor-col-resize justify-center"
        @mousedown="startResizing"
      >
        <div
          ref="resizer"
          class="h-full w-[2px] rounded-full transition-all duration-300 ease-in-out group-hover:bg-gray-400"
        />
      </div>
    </slot>
  </div>
</template>

<script setup lang="ts">
import { useDebounceFn } from '@vueuse/core'
import { computed, ComputedRef, inject, ref, withDefaults } from 'vue'
import type { ListColumn, ListContext } from './types'
import { alignmentMap } from './utils'

interface ListHeaderItemProps {
  item: ListColumn
  debounce?: number
}

interface ListHeaderItemEmits {
  (event: 'columnWidthUpdated'): void
}

const list = inject<ComputedRef<ListContext>>('list')

const props = withDefaults(defineProps<ListHeaderItemProps>(), {
  debounce: 1000,
})

const emit = defineEmits<ListHeaderItemEmits>()

const resizer = ref<HTMLElement | null>(null)
const columnRef = ref<HTMLElement | null>(null)

const widthInPx = computed(() => {
  if (typeof props.item.width === 'string') {
    const parsedWidth = parseInt(props.item.width)
    if (props.item.width.includes('rem')) {
      return parsedWidth * 16
    } else if (props.item.width.includes('px')) {
      return parsedWidth
    }
  }
  return columnRef.value?.offsetWidth || 0
})

const startResizing = (e: MouseEvent) => {
  const initialX = e.clientX
  const initialWidth = widthInPx.value
  const onMouseMove = (e: MouseEvent) => {
    document.body.classList.add('select-none')
    document.body.classList.add('cursor-col-resize')
    if (resizer.value) {
      resizer.value.style.backgroundColor = 'rgb(199 199 199)'
    }
    let newWidth = initialWidth + (e.clientX - initialX)

    props.item.width = `${newWidth < 50 ? 50 : newWidth}px`
    updateWidth(props.item.width)
  }
  const onMouseUp = () => {
    document.body.classList.remove('select-none')
    document.body.classList.remove('cursor-col-resize')
    if (resizer.value) {
      resizer.value.style.backgroundColor = ''
    }
    window.removeEventListener('mousemove', onMouseMove)
    window.removeEventListener('mouseup', onMouseUp)
  }
  window.addEventListener('mousemove', onMouseMove)
  window.addEventListener('mouseup', onMouseUp)
}

const updateWidth = useDebounceFn((width: string) => {
  props.item.width = width
  emit('columnWidthUpdated')
}, props.debounce)
</script>
